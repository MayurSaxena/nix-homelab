My journey through learning Nix is contained in this repo.

The motivation behind this is to have a declarative set up for my homelab VM's and LXC's so that I don't have to document anything.

For other configurations like MacOS, it's nice to have a script for if I ever set up a new Mac.

## Deploying on a new Mac

- Presumably `git` needs to be installed for Flakes.
- Install Nix from Determinate Systems - but do the `--determinate` version because that works better with `nix-darwin`?
- Run the Flake install command (making sure the hostname has an entry in `flake.nix`)
  - `sudo nix run nix-darwin/master#darwin-rebuild -- switch` TODO: Put the git thing somewhere in here.
- One of the YubiKeys must be plugged in so that we can get our secrets decrypted.

### What It Does
 - Enables lots of settings, such as:
   - Touch ID and Watch ID sudo
   - Menu bar widgets like clock and battery percentage
   - Minimal Dock
   - More powerful Finder
   - Installs Homebrew and some GUI casks and apps from the App Store
   - Command line tools I use often enough
   - `zsh` aliases and theme
   - Imports my ED25519 keypair from secrets
   - TODO: SSH config
   - TODO: Some prebaked `nix` dev shells (e.g. Python)
  

## Deploying a new NixOS System

1.  Boot up a new box (probably on Proxmox as an LXC)
  - TODO: Let's get some Terraform or something going on.

-----

### Setting Up Impermanence With LXC
Because what's the point of a declarative configuration if we're not going all in??

TODO: How much of this can we script?

0. When making the LXC, we need to specify 3 mount points:
  - `/boot` - around 1GB
    - I'm not even sure this is entirely necessary but maybe it is for rollbacks.
  - `/nix` - around 4GB
    - This is what will hold all the meat (packages) of the OS.
  - `/persistent` - around 4GB
    - This will house files that should persist across reboots.

1. Snapshot the **rootfs** in a *blank* state
  - The **rootfs** of a CT on ZFS roughly follows the format `rpool/data/subvol-<ctid>-disk-0`.
    - Here, `rpool` is the name of the ZFS pool.
    - The **rootfs** is always (probably) disk 0.
  - `zfs snapshot rpool/data/subvol-<ctid>-disk-0@blank`
    - This will create a snapshot at the base state. It's not exactly blank (i.e. it has enough to boot) but for the most part it's empty.

2. Enter a shell in the container using `pct enter <ctid>`.

3. Inside this shell, we will:
  - Set our environment so we can issue commands.
  - Make directories that will be persisted on our `/persistent` drive.
  - Generate SSH keys and persist them.
  - Persist the unique machine ID generated by `systemd` (I think).
  - Generate the `age` key needed so we can decrypt secrets.

  ```sh
  . etc/set-environment

  mkdir -p /persistent/etc/ssh/
  systemctl start sshd-keygen

  mv /etc/ssh/ssh_host_* /persistent/etc/ssh/
  mv /etc/machine-id /persistent/etc/

  nix shell "nixpkgs#ssh-to-age" --extra-experimental-features "nix-command flakes" --command ssh-to-age -i /persistent/etc/ssh/ssh_host_ed25519_key.pub
  ```

4. Save this `age` key for later and exit the `pct` shell.

5. Add a hookscript to the CT so that on every boot the **rootfs** is reverted back to the *blank* snapshot.
  - See the file at `util/rootfs-impermanence.sh`.
  - Place this file in `/var/lib/vz/snippets` on the PVE host, which likely corresponds with your `local` file storage.
  - `chmod +x /var/lib/vz/snippets/rootfs-impermanence.sh`
  - `pct set <ctid> --hookscript local:snippets/rootfs-impermanence.sh`

6. Finally, we need to make sure that the LXC boots with the right `init` script for the NixOS generation.
  - The default location `nixos-rebuild` ends up placing the script at is `/sbin/init`.
  - This works fine, except for the fact that we don't persist `/sbin` so the next time we reboot we'll be starting up with the default `init` script. If we weren't doing impermanence, we could leave this as is.
  - Rather than persist `/sbin`, I thought I'd make my life more complex by changing the LXC init command.
  - Change the LXC config on the PVE host with the following command: `echo "lxc.init.cmd: /nix/var/nix/profiles/system/init" >> /etc/pve/nodes/proxmox/lxc/<ctid>.conf`

-----

2. Back on a dev system, make a new entry for the hostname in `flake.nix` - and any necessary files in `hosts/` and `services/`.

3. Add the `age` key from above to `.sops.yaml` and run `cd secrets; sops updatekeys *`.

4. Generate any new required secrets using `sops <filename>.yaml`.

5. Push to Github.

6. Re-enter a `pct` shell, run `. /etc/profile ; nixos-rebuild switch --flake github:MayurSaxena/nix-homelab`

7. And now, you should be good to go with an impermanent set up. Test by creating a file somewhere (e.g. `/`) and rebooting.

### What The Base Image Does
 - Enables the firewall
 - Adds my Yubikeys as authorized keys for root via SSH
 - Adds a password in case I never have my Yubikeys (for use through Proxmox console)
 - Enables SSH but disallows root password logins
 - Shell aliases
 - Auto update
 - Persists some critical files and folders for any impermanent image:
    - SSH host keys
    - Unique (systemd?) machine ID
    - /var/log
    - /var/lib/nixos
